serviceAccount: projects/meanrevcontact/serviceAccounts/877026809152-compute@developer.gserviceaccount.com

options:
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET

steps:
  # Build Backend
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "asia-south1-docker.pkg.dev/meanrevcontact/meanrevrepo/backend:$SHORT_SHA",
        "./backend"
      ]

  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "asia-south1-docker.pkg.dev/meanrevcontact/meanrevrepo/backend:$SHORT_SHA"
      ]

  # Build Frontend
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "asia-south1-docker.pkg.dev/meanrevcontact/meanrevrepo/frontend:$SHORT_SHA",
        "./frontend"
      ]

  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "asia-south1-docker.pkg.dev/meanrevcontact/meanrevrepo/frontend:$SHORT_SHA"
      ]

  # Deploy to VM
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - -c
      - |
        echo "üì¶ Copying compose.yml file‚Ä¶"
        gcloud compute scp compose.yml meanrev-app-server:/var/www/app/compose.yml --zone="asia-south1-b"

        echo "üöÄ Deploying update‚Ä¶"
        gcloud compute ssh meanrev-app-server --zone="asia-south1-b" --command "
          cd /var/www/app &&
          echo 'üîê Authenticating Artifact Registry...' &&
          gcloud auth configure-docker asia-south1-docker.pkg.dev --quiet &&
          echo 'üìù Updating version tags...' &&
          sed -i \"s/latest/$SHORT_SHA/g\" compose.yml &&
          echo '‚¨áÔ∏è Pulling new images...' &&
          docker compose pull &&
          echo '‚ôª Restarting services...' &&
          docker compose down &&
          docker compose up -d &&
          echo '‚úÖ Deployment completed successfully!'
        "

images:
  - "asia-south1-docker.pkg.dev/meanrevcontact/meanrevrepo/backend:$SHORT_SHA"
  - "asia-south1-docker.pkg.dev/meanrevcontact/meanrevrepo/frontend:$SHORT_SHA"

timeout: "1800s"
